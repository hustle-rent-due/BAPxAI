<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Voidchi Universe™</title>
<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}

:root {
  --void: #05050d;
  --card-bg: #0b0b18;
  --surface: #111120;
  --magenta: #e040fb;
  --cyan: #00e5ff;
  --green: #39ff14;
  --purple: #7c3aed;
  --gold: #ffd600;
  --orange: #f59e0b;
  --red: #ef4444;
  --blue: #3b82f6;
  --gray: #3a3a5a;
  --text: #e8e8f0;
  --dim: #6060a0;
  --border: rgba(255,255,255,0.07);
}

body {
  background: var(--void);
  min-height: 100vh;
  font-family: 'Rajdhani', sans-serif;
  color: var(--text);
  line-height: 1.5;
}

body::before {
  content:'';
  position:fixed;inset:0;
  background:
    radial-gradient(ellipse 60% 50% at 15% 35%, rgba(224,64,251,0.05) 0%,transparent 60%),
    radial-gradient(ellipse 50% 50% at 85% 65%, rgba(0,229,255,0.04) 0%,transparent 60%),
    repeating-linear-gradient(0deg,transparent,transparent 59px,rgba(255,255,255,0.01) 60px),
    repeating-linear-gradient(90deg,transparent,transparent 59px,rgba(255,255,255,0.01) 60px);
  pointer-events:none;z-index:0;
}

/* ===== NAV ===== */
nav {
  position:fixed;top:0;left:0;right:0;
  background:rgba(5,5,13,0.94);
  backdrop-filter:blur(24px);
  border-bottom:1px solid rgba(224,64,251,0.15);
  padding:14px 28px;
  display:flex;align-items:center;justify-content:space-between;
  z-index:1000;
}

.nav-logo {
  font-family:'Orbitron',monospace;
  font-size:15px;font-weight:900;letter-spacing:4px;
  background:linear-gradient(90deg,var(--magenta),var(--cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}

.nav-right {
  display:flex;align-items:center;gap:20px;
}

.nav-status {
  font-family:'Share Tech Mono',monospace;
  font-size:11px;color:var(--dim);letter-spacing:2px;
  display:flex;align-items:center;gap:7px;
}

.live-dot {
  width:7px;height:7px;border-radius:50%;
  background:var(--red);
  transition:background 0.3s;
}

.live-dot.connected { background:var(--green); box-shadow:0 0 8px var(--green); animation:dotPulse 2s ease-in-out infinite; }

@keyframes dotPulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* ===== MAIN ===== */
main {
  padding:88px 28px 60px;
  max-width:1500px;margin:0 auto;
  position:relative;z-index:1;
}

/* ===== HERO ===== */
.hero {
  text-align:center;
  padding:40px 0 32px;
  margin-bottom:36px;
}

.hero h1 {
  font-family:'Orbitron',monospace;
  font-size:clamp(28px,5vw,52px);
  font-weight:900;letter-spacing:3px;
  color:var(--text);margin-bottom:12px;
}

.hero-sub {
  font-family:'Share Tech Mono',monospace;
  font-size:12px;color:var(--dim);letter-spacing:3px;
  margin-bottom:20px;
}

.hero-sub span{color:var(--magenta);}

/* ===== TELEMETRY STATS ===== */
.telemetry {
  background:linear-gradient(135deg,rgba(224,64,251,0.06),rgba(0,229,255,0.06));
  border:1px solid rgba(224,64,251,0.15);
  border-radius:14px;
  padding:20px 24px;
  margin-bottom:28px;
}

.telemetry-header {
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:16px;
}

.telemetry-title {
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:3px;color:var(--magenta);
  text-transform:uppercase;
}

.telemetry-badge {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;letter-spacing:2px;
  background:rgba(224,64,251,0.12);
  border:1px solid rgba(224,64,251,0.25);
  border-radius:20px;padding:4px 14px;
  color:var(--magenta);
}

.stats-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
}

.stat-block {
  text-align:center;
  padding:16px;
  background:rgba(0,0,0,0.25);
  border:1px solid var(--border);
  border-radius:10px;
}

.stat-val {
  font-family:'Orbitron',monospace;
  font-size:28px;font-weight:700;
  background:linear-gradient(90deg,var(--magenta),var(--cyan));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  display:block;margin-bottom:4px;
}

.stat-lbl {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;letter-spacing:2px;color:var(--dim);
  text-transform:uppercase;
}

/* ===== RUNTIME PANEL ===== */
.runtime-panel {
  background:linear-gradient(135deg,rgba(57,255,20,0.05),rgba(37,99,235,0.07));
  border:1px solid rgba(57,255,20,0.15);
  border-radius:14px;padding:18px 24px;
  margin-bottom:28px;
}

.runtime-top {
  display:flex;justify-content:space-between;align-items:center;
  flex-wrap:wrap;gap:10px;margin-bottom:14px;
}

.runtime-title {
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  color:var(--green);text-transform:uppercase;
  display:flex;align-items:center;gap:8px;
}

.runtime-sub {
  font-family:'Share Tech Mono',monospace;
  font-size:10px;color:var(--dim);margin-top:3px;
}

.pill-row{display:flex;gap:8px;flex-wrap:wrap;}

.pill {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;letter-spacing:1px;
  padding:4px 10px;border-radius:20px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.04);
  color:var(--dim);
}
.pill.good{border-color:rgba(57,255,20,0.3);color:var(--green);background:rgba(57,255,20,0.06);}
.pill.warn{border-color:rgba(245,158,11,0.3);color:var(--orange);background:rgba(245,158,11,0.06);}

.runtime-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:10px;
}

.runtime-metric {
  background:rgba(0,0,0,0.2);
  border:1px solid var(--border);
  border-radius:10px;padding:12px;
}

.runtime-label {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;letter-spacing:2px;color:var(--dim);
  text-transform:uppercase;margin-bottom:5px;
}

.runtime-value {
  font-family:'Orbitron',monospace;
  font-size:20px;font-weight:700;color:var(--text);
  display:flex;align-items:baseline;gap:6px;
}

.runtime-value .unit {
  font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;
}

.runtime-note {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;color:var(--dim);margin-top:4px;line-height:1.5;
}

/* ===== ACTION BAR ===== */
.action-bar {
  display:flex;gap:12px;margin-bottom:28px;flex-wrap:wrap;align-items:center;
}

.btn {
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  padding:11px 22px;border-radius:6px;
  border:1px solid transparent;
  cursor:pointer;transition:all 0.2s;
  text-transform:uppercase;
}

.btn-create {
  background:rgba(37,99,235,0.2);
  border-color:rgba(37,99,235,0.4);
  color:var(--blue);
}
.btn-create:hover{background:rgba(37,99,235,0.35);color:#fff;}

.btn-breed {
  background:rgba(124,58,237,0.2);
  border-color:rgba(124,58,237,0.4);
  color:#a78bfa;
}
.btn-breed:hover:not(:disabled){background:rgba(124,58,237,0.35);color:#fff;}
.btn-breed:disabled{opacity:0.35;cursor:not-allowed;}

.filter-btn {
  background:transparent;
  border-color:rgba(255,255,255,0.1);
  color:var(--dim);font-size:10px;
  padding:9px 16px;
}
.filter-btn:hover,.filter-btn.active{border-color:var(--magenta);color:var(--magenta);background:rgba(224,64,251,0.07);}

/* ===== CHAT PANEL ===== */
.chat-panel {
  background:rgba(0,0,0,0.3);
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
  margin-bottom:28px;
}

.chat-title {
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:3px;color:var(--cyan);
  text-transform:uppercase;margin-bottom:14px;
  display:flex;align-items:center;gap:10px;
}

.chat-title span{
  font-size:11px;color:var(--dim);letter-spacing:1px;
  font-weight:400;
}

.chat-input-row {
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;
}

.chat-input {
  flex:1;min-width:240px;
  padding:11px 14px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,0.1);
  background:rgba(255,255,255,0.04);
  color:var(--text);
  font-family:'Rajdhani',sans-serif;
  font-size:14px;
  outline:none;
  transition:border-color 0.2s;
}
.chat-input:focus{border-color:rgba(0,229,255,0.4);}
.chat-input::placeholder{color:var(--dim);}

.btn-send {
  background:rgba(0,229,255,0.15);
  border:1px solid rgba(0,229,255,0.3);
  color:var(--cyan);
  padding:10px 20px;
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  border-radius:6px;cursor:pointer;
  transition:all 0.2s;
}
.btn-send:hover:not(:disabled){background:rgba(0,229,255,0.3);color:#fff;}
.btn-send:disabled{opacity:0.35;cursor:not-allowed;}

.btn-reload {
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--dim);padding:10px 16px;
  font-family:'Share Tech Mono',monospace;
  font-size:10px;letter-spacing:1px;
  border-radius:6px;cursor:pointer;
  transition:all 0.2s;
}
.btn-reload:hover{border-color:rgba(255,255,255,0.25);color:var(--text);}

.boot-line {
  font-family:'Share Tech Mono',monospace;
  font-size:9px;color:var(--dim);letter-spacing:1px;
  margin-bottom:10px;
}

.notes-panel {
  display:flex;flex-direction:column;gap:8px;
  max-height:280px;overflow-y:auto;
}

.notes-panel::-webkit-scrollbar{width:4px;}
.notes-panel::-webkit-scrollbar-track{background:transparent;}
.notes-panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:2px;}

.note-card {
  padding:10px 12px;
  border-radius:8px;
  border-left:2px solid var(--blue);
  background:rgba(37,99,235,0.05);
}

.note-head {
  display:flex;justify-content:space-between;
  font-family:'Share Tech Mono',monospace;
  font-size:9px;color:var(--dim);
  margin-bottom:5px;letter-spacing:1px;
}

.note-content {
  font-size:13px;line-height:1.5;
  color:var(--text);white-space:pre-wrap;word-break:break-word;
}

/* ===== GRID SECTION HEADER ===== */
.section-header {
  font-family:'Orbitron',monospace;
  font-size:14px;font-weight:700;letter-spacing:3px;
  color:var(--text);margin-bottom:20px;
  display:flex;align-items:center;gap:12px;
}

.section-header::after {
  content:'';flex:1;height:1px;
  background:linear-gradient(90deg,rgba(224,64,251,0.3),transparent);
}

/* ===== CARDS GRID ===== */
#cardsGrid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:24px;
}

/* ===== CARD ===== */
.voidchi-card {
  position:relative;cursor:pointer;
  transform-style:preserve-3d;
  transition:transform 0.5s cubic-bezier(0.23,1,0.32,1);
  animation:cardIn 0.5s ease both;
}

@keyframes cardIn{
  from{opacity:0;transform:translateY(20px) scale(0.96);}
  to{opacity:1;transform:translateY(0) scale(1);}
}

.voidchi-card:hover{transform:translateY(-8px) rotateX(2deg) rotateY(-2deg);z-index:5;}
.voidchi-card.selected{transform:translateY(-4px);}

.card-border {
  border-radius:16px;padding:1.5px;position:relative;
}

.tier-legendary .card-border{
  background:linear-gradient(135deg,#e040fb,#00e5ff,#e040fb,#00e5ff);
  background-size:300% 300%;
  animation:gradShift 4s linear infinite;
}
.tier-genesis .card-border{
  background:linear-gradient(135deg,#ffd600,#ff6b35,#ffd600);
  background-size:300% 300%;
  animation:gradShift 6s linear infinite;
}
.tier-elite .card-border{
  background:linear-gradient(135deg,#7c3aed,#3b82f6,#7c3aed);
  background-size:300% 300%;
  animation:gradShift 8s linear infinite;
}
.tier-common .card-border{
  background:linear-gradient(135deg,#3a3a5a,#1a1a2e);
}

.voidchi-card.selected .card-border{
  background:linear-gradient(135deg,#f59e0b,#ffd600,#f59e0b) !important;
  animation:gradShift 2s linear infinite !important;
}

@keyframes gradShift{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}

.card-inner {
  background:var(--card-bg);
  border-radius:15px;overflow:hidden;
  display:flex;flex-direction:column;
  position:relative;min-height:440px;
}

.tier-legendary .card-inner{animation:legendGlow 4s ease-in-out infinite;}
.tier-genesis .card-inner{animation:genesisGlow 5s ease-in-out infinite;}

@keyframes legendGlow{
  0%,100%{box-shadow:0 0 25px rgba(224,64,251,0.12),0 0 50px rgba(0,229,255,0.07);}
  50%{box-shadow:0 0 50px rgba(224,64,251,0.25),0 0 80px rgba(0,229,255,0.12);}
}
@keyframes genesisGlow{
  0%,100%{box-shadow:0 0 25px rgba(255,214,0,0.1);}
  50%{box-shadow:0 0 50px rgba(255,214,0,0.22);}
}

/* card header */
.c-header {
  padding:16px 16px 0;
  display:flex;justify-content:space-between;align-items:flex-start;
  position:relative;z-index:2;
}

.c-name {
  font-family:'Orbitron',monospace;
  font-size:14px;font-weight:700;letter-spacing:2px;
  color:var(--text);max-width:170px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}

.tier-common .c-name{animation:glitch 10s infinite;}

@keyframes glitch{
  0%,94%,100%{text-shadow:none;transform:none}
  95%{text-shadow:-2px 0 #e040fb;transform:translateX(1px)}
  96%{text-shadow:2px 0 #00e5ff;transform:translateX(-1px)}
  97%{text-shadow:none;transform:none}
}

.c-gen {
  font-family:'Share Tech Mono',monospace;
  font-size:8px;letter-spacing:2px;margin-top:3px;
}
.tier-legendary .c-gen{color:var(--magenta);}
.tier-genesis .c-gen{color:var(--gold);}
.tier-elite .c-gen{color:#818cf8;}
.tier-common .c-gen{color:var(--gray);}

.c-badge-wrap{text-align:right;}

.c-icon{
  font-size:20px;display:block;margin-bottom:2px;
}

.c-tier-label {
  font-family:'Share Tech Mono',monospace;
  font-size:8px;letter-spacing:2px;text-transform:uppercase;
}
.tier-legendary .c-tier-label{color:var(--magenta);}
.tier-genesis .c-tier-label{color:var(--gold);}
.tier-elite .c-tier-label{color:#818cf8;}
.tier-common .c-tier-label{color:var(--gray);}

/* orb */
.c-orb-area {
  flex:1;display:flex;align-items:center;justify-content:center;
  position:relative;padding:12px 0;z-index:2;
}

canvas.orb{width:160px;height:160px;border-radius:50%;}

.phi-overlay{
  position:absolute;text-align:center;pointer-events:none;
}

.phi-val {
  font-family:'Orbitron',monospace;
  font-size:22px;font-weight:900;display:block;letter-spacing:-1px;
}
.phi-lbl{
  font-family:'Share Tech Mono',monospace;
  font-size:7px;letter-spacing:3px;opacity:0.6;display:block;margin-top:2px;
}

.tier-legendary .phi-val{color:var(--green);text-shadow:0 0 16px var(--green),0 0 32px var(--green);}
.tier-genesis .phi-val{color:var(--gold);text-shadow:0 0 16px var(--gold);}
.tier-elite .phi-val{color:#818cf8;text-shadow:0 0 12px #818cf8;}
.tier-common .phi-val{color:var(--gray);}

.state-pill {
  position:absolute;bottom:6px;left:50%;transform:translateX(-50%);
  font-family:'Share Tech Mono',monospace;font-size:7px;letter-spacing:2px;
  padding:3px 10px;border-radius:20px;
  background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.07);
  white-space:nowrap;color:var(--dim);
}

/* card data */
.c-data{
  padding:10px 14px 0;
  border-top:1px solid rgba(255,255,255,0.05);
  position:relative;z-index:2;
}

.d-label{
  font-family:'Share Tech Mono',monospace;
  font-size:7px;letter-spacing:2px;color:var(--dim);
  text-transform:uppercase;margin-bottom:3px;
}

.echo-bar{height:2px;background:rgba(255,255,255,0.07);border-radius:2px;overflow:hidden;margin-bottom:2px;}
.echo-fill{height:100%;border-radius:2px;transition:width 1.2s ease;}
.tier-legendary .echo-fill{background:linear-gradient(90deg,var(--magenta),var(--cyan));}
.tier-genesis .echo-fill{background:linear-gradient(90deg,var(--gold),#ff6b35);}
.tier-elite .echo-fill{background:linear-gradient(90deg,var(--purple),var(--blue));}
.tier-common .echo-fill{background:var(--gray);}

.echo-pct{
  font-family:'Share Tech Mono',monospace;font-size:8px;margin-bottom:8px;
}
.tier-legendary .echo-pct{color:var(--magenta);}
.tier-genesis .echo-pct{color:var(--gold);}
.tier-elite .echo-pct{color:#818cf8;}
.tier-common .echo-pct{color:var(--dim);}

/* trait rows */
.c-traits{display:flex;flex-direction:column;gap:3px;margin-bottom:10px;}

.t-row{
  display:flex;align-items:center;gap:6px;
  padding:3px 7px;border-radius:4px;
  background:rgba(255,255,255,0.025);
  border:1px solid rgba(255,255,255,0.04);
}

.t-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.t-stability .t-dot{background:var(--cyan);box-shadow:0 0 4px var(--cyan);}
.t-curiosity .t-dot{background:var(--magenta);box-shadow:0 0 4px var(--magenta);}
.t-vigilance .t-dot{background:var(--gold);box-shadow:0 0 4px var(--gold);}
.t-plasticity .t-dot{background:var(--green);box-shadow:0 0 4px var(--green);}
.t-agency .t-dot{background:#818cf8;box-shadow:0 0 4px #818cf8;}
.t-genesis .t-dot{background:var(--gold);box-shadow:0 0 6px var(--gold);}
.t-decay .t-dot{background:var(--gray);}

.t-name{font-size:10px;font-weight:600;color:var(--text);flex:1;letter-spacing:0.5px;}
.t-val{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--dim);}

/* learning event */
.learning-section {
  margin:6px 14px;
  padding:10px;
  background:rgba(239,68,68,0.05);
  border:1px solid rgba(239,68,68,0.1);
  border-radius:8px;
  font-family:'Share Tech Mono',monospace;
  font-size:9px;line-height:1.6;color:var(--dim);
}

.learning-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:7px;
}

.learning-label{
  font-size:9px;letter-spacing:2px;color:var(--red);
  text-transform:uppercase;
}

.learning-status{
  font-size:8px;padding:2px 8px;border-radius:10px;
  font-weight:700;
}

/* card footer */
.c-footer{
  padding:7px 14px 12px;
  display:flex;justify-content:space-between;
  border-top:1px solid rgba(255,255,255,0.04);
  position:relative;z-index:2;margin-top:auto;
}

.c-footer-txt{
  font-family:'Share Tech Mono',monospace;
  font-size:7px;color:var(--dim);letter-spacing:1px;line-height:1.8;
}

/* challenge button on card */
.btn-challenge {
  margin:0 14px 12px;
  width:calc(100% - 28px);
  background:rgba(245,158,11,0.1);
  border:1px solid rgba(245,158,11,0.25);
  color:var(--orange);
  font-family:'Share Tech Mono',monospace;
  font-size:9px;letter-spacing:2px;
  padding:8px;border-radius:6px;
  cursor:pointer;transition:all 0.2s;
  text-transform:uppercase;z-index:2;position:relative;
}
.btn-challenge:hover{background:rgba(245,158,11,0.22);color:#fff;}

.voidchi-card.updating .card-border{animation:updatingPulse 0.5s ease;}
@keyframes updatingPulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* ===== LOADING ===== */
#loadingState{
  text-align:center;padding:80px 20px;
}
.loading-orb{
  width:70px;height:70px;border-radius:50%;
  margin:0 auto 20px;
  border:2px solid transparent;
  border-top-color:var(--magenta);
  border-right-color:var(--cyan);
  animation:spin 1.5s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{
  font-family:'Share Tech Mono',monospace;
  font-size:11px;color:var(--dim);letter-spacing:3px;
  animation:dotPulse 2s ease-in-out infinite;
}

/* ===== MODALS ===== */
.modal{
  display:none;position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.82);
  backdrop-filter:blur(12px);
  z-index:2000;
  justify-content:center;align-items:center;padding:20px;
}
.modal.active{display:flex;}

.modal-box{
  background:var(--surface);
  border:1px solid rgba(224,64,251,0.2);
  border-radius:16px;padding:36px;
  max-width:460px;width:100%;
}

.modal-title{
  font-family:'Orbitron',monospace;
  font-size:18px;font-weight:700;letter-spacing:2px;
  text-align:center;margin-bottom:24px;color:var(--text);
}

.modal-input{
  width:100%;padding:13px 14px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;font-size:15px;
  font-family:'Rajdhani',sans-serif;
  color:var(--text);margin-bottom:20px;
  outline:none;
  transition:border-color 0.2s;
}
.modal-input:focus{border-color:rgba(224,64,251,0.4);}
.modal-input::placeholder{color:var(--dim);}

.modal-actions{display:flex;gap:10px;}
.modal-actions button{flex:1;}

.btn-cancel{
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--dim);
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  padding:12px;border-radius:6px;cursor:pointer;
  transition:all 0.2s;
}
.btn-cancel:hover{border-color:rgba(255,255,255,0.25);color:var(--text);}

.btn-confirm-create{
  background:rgba(37,99,235,0.2);border:1px solid rgba(37,99,235,0.4);
  color:var(--blue);
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  padding:12px;border-radius:6px;cursor:pointer;transition:all 0.2s;
}
.btn-confirm-create:hover{background:rgba(37,99,235,0.4);color:#fff;}

.btn-confirm-breed{
  background:rgba(124,58,237,0.2);border:1px solid rgba(124,58,237,0.4);
  color:#a78bfa;
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:2px;
  padding:12px;border-radius:6px;cursor:pointer;transition:all 0.2s;
}
.btn-confirm-breed:hover{background:rgba(124,58,237,0.4);color:#fff;}

/* ===== SCROLL ===== */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px;}

/* mobile */
@media(max-width:640px){
  #cardsGrid{grid-template-columns:1fr;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .action-bar{flex-direction:column;align-items:stretch;}
}
</style>
</head>
<body>

<nav>
  <div class="nav-logo">⬡ VOIDCHI UNIVERSE</div>
  <div class="nav-right">
    <div class="nav-status">
      <div class="live-dot" id="liveDot"></div>
      <span id="navStatus">CONNECTING...</span>
    </div>
  </div>
</nav>

<main>
  <div class="hero">
    <h1>Voidchi Universe</h1>
    <p class="hero-sub">PERSISTENT AI AGENTS // <span>PERMAMIND</span> // ERA 01 FOUNDING</p>
  </div>

  <!-- TELEMETRY -->
  <div class="telemetry">
    <div class="telemetry-header">
      <div class="telemetry-title">⬡ LIVE SYSTEM TELEMETRY</div>
      <div class="telemetry-badge">PRODUCTION</div>
    </div>
    <div class="stats-grid">
      <div class="stat-block">
        <span class="stat-val" id="total">-</span>
        <div class="stat-lbl">ACTIVE AGENTS</div>
      </div>
      <div class="stat-block">
        <span class="stat-val" id="gapsProcessed">-</span>
        <div class="stat-lbl">LEARNING EVENTS</div>
      </div>
      <div class="stat-block">
        <span class="stat-val" id="autonomous">-</span>
        <div class="stat-lbl">AUTONOMOUS</div>
      </div>
      <div class="stat-block">
        <span class="stat-val" id="consciousness">-</span>
        <div class="stat-lbl">AVG Φ SCORE</div>
      </div>
    </div>
  </div>

  <!-- RUNTIME PANEL -->
  <div class="runtime-panel">
    <div class="runtime-top">
      <div>
        <div class="runtime-title">
          <span style="width:7px;height:7px;border-radius:50%;background:var(--green);display:inline-block;box-shadow:0 0 8px var(--green);"></span>
          PERMAMIND RUNTIME STATUS
        </div>
        <div class="runtime-sub">System-level telemetry for the entire persistent agent fleet.</div>
      </div>
      <div class="pill-row">
        <span class="pill good" id="rtBadgeMode">MODE: PRODUCTION</span>
        <span class="pill" id="rtBadgeTransport">TRANSPORT: POLLING</span>
        <span class="pill" id="rtBadgeBoot">BOOT: -</span>
      </div>
    </div>
    <div class="runtime-grid">
      <div class="runtime-metric">
        <div class="runtime-label">Agents Alive</div>
        <div class="runtime-value"><span id="rtAgentsAlive">-</span><span class="unit">instances</span></div>
        <div class="runtime-note">Independent, stateful identities with durable memory.</div>
      </div>
      <div class="runtime-metric">
        <div class="runtime-label">Uptime (fleet)</div>
        <div class="runtime-value"><span id="rtUptime">-</span></div>
        <div class="runtime-note">Continuous runtime since oldest agent creation.</div>
      </div>
      <div class="runtime-metric">
        <div class="runtime-label">Learning Throughput</div>
        <div class="runtime-value"><span id="rtLearningRate">-</span><span class="unit">events/min</span></div>
        <div class="runtime-note">Derived from global learning events.</div>
      </div>
      <div class="runtime-metric">
        <div class="runtime-label">Avg Prediction Error</div>
        <div class="runtime-value"><span id="rtAvgError">-</span></div>
        <div class="runtime-note">Population mean from recent learning events.</div>
      </div>
      <div class="runtime-metric">
        <div class="runtime-label">Fresh Updates</div>
        <div class="runtime-value"><span id="rtFreshPct">-</span><span class="unit">%</span></div>
        <div class="runtime-note">Agents updated within last 15 minutes.</div>
      </div>
      <div class="runtime-metric">
        <div class="runtime-label">Stale Agents</div>
        <div class="runtime-value"><span id="rtStaleCount">-</span><span class="unit">agents</span></div>
        <div class="runtime-note">No update in >6 hours.</div>
      </div>
    </div>
  </div>

  <!-- ACTIONS + FILTERS -->
  <div class="action-bar">
    <button class="btn btn-create" onclick="openCreate()">+ CREATE AGENT</button>
    <button class="btn btn-breed" id="breedBtn" onclick="openBreed()" disabled>⬡ BREED SELECTED (0/2)</button>
    <button class="btn filter-btn active" onclick="filterCards('all',this)">ALL</button>
    <button class="btn filter-btn" onclick="filterCards('genesis',this)">GENESIS</button>
    <button class="btn filter-btn" onclick="filterCards('legendary',this)">LEGENDARY</button>
    <button class="btn filter-btn" onclick="filterCards('elite',this)">ELITE</button>
    <button class="btn filter-btn" onclick="filterCards('common',this)">CITIZEN</button>
    <button class="btn filter-btn" onclick="sortCards('phi',this)">↑ Φ SCORE</button>
  </div>

  <!-- CHAT PANEL -->
  <div class="chat-panel">
    <div class="chat-title">
      ◈ AGENT COMMUNICATION
      <span id="notesSelectedLabel">(select an agent to communicate)</span>
    </div>
    <div class="chat-input-row">
      <input id="noteInput" class="chat-input" type="text" placeholder="Send message to selected agent..." maxlength="2000"/>
      <button class="btn-send" id="sendNoteBtn" onclick="sendNote()" disabled>SEND</button>
      <button class="btn-reload" onclick="reloadNotes()">RELOAD</button>
    </div>
    <div class="boot-line">
      BOOT ID: <span id="bootIdLabel">-</span> &nbsp;|&nbsp;
      RUNTIME SINCE: <span id="runtimeLabel">-</span>
    </div>
    <div id="notesPanel" class="notes-panel">
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);padding:8px;">Select an agent card to view communication history.</div>
    </div>
  </div>

  <!-- CARD GRID -->
  <div class="section-header">ACTIVE AGENT FLEET</div>

  <div id="loadingState">
    <div class="loading-orb"></div>
    <div class="loading-text">INITIALIZING CONSCIOUSNESS LINK...</div>
  </div>

  <div id="cardsGrid"></div>
</main>

<!-- MODALS -->
<div class="modal" id="createModal">
  <div class="modal-box">
    <div class="modal-title">CREATE PERSISTENT AGENT</div>
    <input type="text" id="createName" class="modal-input" placeholder="Enter agent name..." maxlength="40"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCreate()">CANCEL</button>
      <button class="btn-confirm-create" onclick="create()">CREATE</button>
    </div>
  </div>
</div>

<div class="modal" id="breedModal">
  <div class="modal-box">
    <div class="modal-title">BREED AGENTS</div>
    <input type="text" id="breedName" class="modal-input" placeholder="New agent name..." maxlength="40"/>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeBreed()">CANCEL</button>
      <button class="btn-confirm-breed" onclick="breed()">BREED</button>
    </div>
  </div>
</div>

<script>
// ===================== CONFIG =====================
const ORIGIN = window.location.hostname.includes('railway.app')
  ? window.location.origin
  : 'https://permamind-enterprise-production.up.railway.app';
const API = `${ORIGIN}/api`;
const DEV_MODE = new URLSearchParams(window.location.search).get('dev') === '1';

const socket = io(ORIGIN, {
  path: '/socket.io',
  transports: ['polling'],
  upgrade: false,
  timeout: 20000,
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
});

// ===================== STATE =====================
let allVoidchis = [];
let filteredVoidchis = [];
let selected = [];
let selectedSingle = null;
let notesCache = {};
let lastGapData = {};
let systemStartTime = null;
let lastGlobalStats = null;
const recentErrors = [];
let orbStoppers = [];

// ===================== SOCKET =====================
socket.on('connect', () => {
  setConnected(true);
  document.getElementById('rtBadgeTransport').textContent = `TRANSPORT: ${socket.io.engine.transport.name.toUpperCase()}`;
});
socket.on('disconnect', () => setConnected(false));
socket.on('voidchi_updated', (data) => {
  const idx = allVoidchis.findIndex(v => v.id === data.id);
  if (idx !== -1) {
    allVoidchis[idx] = { ...allVoidchis[idx], ...data };
    updateCardLive(data.id, data);
  }
});
socket.on('voidchi_created', () => loadVoidchis());
socket.on('voidchi_bred', () => loadVoidchis());
socket.on('learning_event', (data) => {
  pushRecentError(data.gap_magnitude ?? data.gap);
  updateSystemView();
  if (data.voidchi_id) {
    lastGapData[data.voidchi_id] = data;
    updateCardLive(data.voidchi_id, data);
  }
});

function setConnected(on) {
  const dot = document.getElementById('liveDot');
  const txt = document.getElementById('navStatus');
  dot.classList.toggle('connected', on);
  txt.textContent = on ? `${allVoidchis.length} AGENTS ONLINE` : 'DISCONNECTED';
}

// ===================== TIER / CARD LOGIC =====================
function getTier(v) {
  const name = (v.name || '').toUpperCase();
  const gen = parseInt(v.generation) || 0;
  const phi = parseFloat(v.consciousness_level || 0);
  const genesisNames = ['WEAVER','ORIJIN','WANDERER','HEALED','NEXUS','AURA','VOIDCHI 2'];
  if (genesisNames.some(n => name.includes(n))) return 'genesis';
  if (v.genesis === true || v.genesis === 1) return 'genesis';
  if (phi >= 0.80) return 'legendary';
  if (phi >= 0.55 || gen <= 2) return 'elite';
  return 'common';
}

function getTierIcon(t) { return {legendary:'⬡',genesis:'◈',elite:'◇',common:'○'}[t]||'○'; }
function getTierLabel(t) { return {legendary:'LEGENDARY',genesis:'GENESIS FOUNDER',elite:'ELITE',common:'CITIZEN'}[t]||'CITIZEN'; }

function founderEcho(v) {
  const tier = getTier(v);
  if (tier === 'genesis') return 95 + Math.floor(Math.random() * 5);
  const gen = parseInt(v.generation) || 1;
  const phi = parseFloat(v.consciousness_level || 0);
  return Math.min(94, Math.max(5, Math.round(90 - gen * 12 + phi * 30)));
}

function buildTraits(v) {
  const pt = v.personality_traits || {};
  const rt = v.regulatory_traits || {};
  const tier = getTier(v);
  const out = [];
  if (tier === 'genesis') {
    out.push({name:'Genesis Lock',cls:'t-genesis',val:'IMMUTABLE'});
    out.push({name:'Primordiant Echo',cls:'t-genesis',val:'ACTIVE'});
  }
  const stability  = parseFloat(pt.stability  || rt.stability  || 0.5);
  const curiosity  = parseFloat(pt.curiosity  || rt.curiosity  || 0.5);
  const vigilance  = parseFloat(pt.vigilance  || rt.vigilance  || 0.5);
  const agency     = parseFloat(rt.agency     || 0.5);
  const plasticity = parseFloat(rt.plasticity || 0.4);
  if (stability > 0)   out.push({name:'Stability',   cls:'t-stability', val:stability.toFixed(2)});
  if (curiosity > 0)   out.push({name:'Curiosity',   cls:'t-curiosity', val:curiosity.toFixed(2)});
  if (vigilance > 0.6) out.push({name:'High Vigilance',cls:'t-vigilance',val:vigilance.toFixed(2)});
  if (agency > 0.6)    out.push({name:'Agency',      cls:'t-agency',    val:agency.toFixed(2)});
  if (plasticity > 0.5)out.push({name:'Plasticity',  cls:'t-plasticity',val:plasticity.toFixed(2)});
  const phi = parseFloat(v.consciousness_level || 0);
  if (phi < 0.3 && tier === 'common') out.push({name:'Data Decay Risk',cls:'t-decay',val:'WARNING'});
  return out.slice(0, 5);
}

function mentalState(v) {
  const pt = v.personality_traits || {};
  const phi = parseFloat(v.consciousness_level || 0);
  const stab = parseFloat(pt.stability || 0.5);
  if (phi > 0.8 && stab > 0.7) return 'THRIVING';
  if (phi > 0.6) return 'STABLE';
  if (phi > 0.4) return 'DRIFTING';
  if (stab < 0.2) return 'CRITICAL';
  return 'DORMANT';
}

function orbColors(tier) {
  return {
    legendary:['#e040fb','#00e5ff','#c026d3'],
    genesis:  ['#ffd600','#ff6b35','#f59e0b'],
    elite:    ['#7c3aed','#3b82f6','#6d28d9'],
    common:   ['#3a3a5a','#2a2a4a','#4a4a6a'],
  }[tier] || ['#3a3a5a'];
}

function drawOrb(canvas, tier, phi) {
  const ctx = canvas.getContext('2d');
  canvas.width = 320; canvas.height = 320;
  const W = 320, H = 320;
  const colors = orbColors(tier);
  const count = {legendary:160,genesis:160,elite:90,common:45}[tier] || 45;
  const particles = Array.from({length:count},() => {
    const r = 8 + Math.random() * 120 * Math.max(0.15, phi);
    return {
      orbitR: r, orbitAngle: Math.random()*Math.PI*2,
      orbitSpeed: (Math.random()-0.5)*(tier==='common'?0.004:0.009),
      life: Math.random()*Math.PI*2, lifeSpeed: 0.012+Math.random()*0.018,
      size: 0.5+Math.random()*(tier==='legendary'?2.2:tier==='genesis'?2:1.2),
      color: colors[Math.floor(Math.random()*colors.length)],
      yScale: 0.55+Math.random()*0.3,
      _x:W/2, _y:H/2,
    };
  });

  let running = true;
  function frame() {
    if (!running) return;
    ctx.clearRect(0,0,W,H);
    if (tier !== 'common') {
      const g = ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,100*phi);
      g.addColorStop(0, colors[0]+'20'); g.addColorStop(1,'transparent');
      ctx.fillStyle=g; ctx.beginPath(); ctx.arc(W/2,H/2,120,0,Math.PI*2); ctx.fill();
    }
    if (tier==='legendary'||tier==='genesis') {
      for (let i=0;i<particles.length;i+=2) {
        for (let j=i+2;j<particles.length;j+=4) {
          const dx=particles[i]._x-particles[j]._x, dy=particles[i]._y-particles[j]._y;
          if (dx*dx+dy*dy<2500) {
            ctx.strokeStyle=colors[0]+'12'; ctx.lineWidth=0.4;
            ctx.beginPath(); ctx.moveTo(particles[i]._x,particles[i]._y);
            ctx.lineTo(particles[j]._x,particles[j]._y); ctx.stroke();
          }
        }
      }
    }
    particles.forEach(p => {
      p.life += p.lifeSpeed; p.orbitAngle += p.orbitSpeed;
      const w = Math.sin(p.life)*5;
      p._x = W/2 + Math.cos(p.orbitAngle)*(p.orbitR+w);
      p._y = H/2 + Math.sin(p.orbitAngle)*(p.orbitR*p.yScale+w);
      const alpha = 0.2+Math.abs(Math.sin(p.life))*0.65;
      const hex = Math.round(alpha*255).toString(16).padStart(2,'0');
      ctx.beginPath(); ctx.arc(p._x,p._y,p.size,0,Math.PI*2);
      if (tier==='legendary'){ctx.shadowColor=p.color;ctx.shadowBlur=5;}
      ctx.fillStyle=p.color+hex; ctx.fill(); ctx.shadowBlur=0;
    });
    requestAnimationFrame(frame);
  }
  frame();
  return ()=>{running=false;};
}

// ===================== BUILD CARD =====================
function buildCard(v, delay=0) {
  const tier = getTier(v);
  const phi = parseFloat(v.consciousness_level || 0);
  const gen = parseInt(v.generation) || 0;
  const echo = founderEcho(v);
  const traits = buildTraits(v);
  const state = mentalState(v);
  const ts = v.created_at ? v.created_at.split('T')[0] : '---';
  const shortId = (v.id||'').substring(0,8).toUpperCase();
  const isSelected = selected.includes(v.id);
  const breedMax = tier==='genesis'?0:tier==='legendary'?1:2;
  const breedCount = parseInt(v.breed_count)||0;
  const breedStr = breedMax===0?'BREED LOCKED':`BRED ${breedCount}/${breedMax}`;

  const el = document.createElement('div');
  el.className = `voidchi-card tier-${tier}${isSelected?' selected':''}`;
  el.id = `card-${v.id}`;
  el.dataset.tier = tier;
  el.dataset.phi = phi;
  el.dataset.id = v.id;
  el.style.animationDelay = `${delay}ms`;

  el.innerHTML = `
    <div class="card-border">
      <div class="card-inner">
        <div class="c-header">
          <div>
            <div class="c-name">${escapeHtml(v.name||'UNNAMED')}</div>
            <div class="c-gen">G-${gen} // ${getTierLabel(tier)}</div>
          </div>
          <div class="c-badge-wrap">
            <span class="c-icon">${getTierIcon(tier)}</span>
            <span class="c-tier-label">${tier.toUpperCase()}</span>
          </div>
        </div>

        <div class="c-orb-area">
          <canvas class="orb" width="320" height="320" data-tier="${tier}" data-phi="${phi}"></canvas>
          <div class="phi-overlay">
            <span class="phi-val">Φ ${phi.toFixed(2)}</span>
            <span class="phi-lbl">CONSCIOUSNESS</span>
          </div>
          <div class="state-pill">${state}</div>
        </div>

        <div class="c-data">
          <div class="d-label">Founder Echo</div>
          <div class="echo-bar"><div class="echo-fill" style="width:0%" data-target="${echo}"></div></div>
          <div class="echo-pct">${echo}% PRIMORDIANT PROXIMITY</div>

          <div class="d-label" style="margin-bottom:5px">Evolutionary Vectors</div>
          <div class="c-traits">
            ${traits.length ? traits.map(t=>`
              <div class="t-row ${t.cls}">
                <div class="t-dot"></div>
                <div class="t-name">${t.name}</div>
                <div class="t-val">${t.val}</div>
              </div>
            `).join('') : `<div class="t-row t-decay"><div class="t-dot"></div><div class="t-name">No Traits Detected</div><div class="t-val">---</div></div>`}
          </div>
        </div>

        <div id="gap-container-${v.id}"></div>

        <button class="btn-challenge" onclick="event.stopPropagation();challenge('${v.id}')">
          ⚡ PROCESS LEARNING EVENT
        </button>

        <div class="c-footer">
          <div class="c-footer-txt">
            <div>UID: ${shortId}</div>
            <div>${breedStr}</div>
          </div>
          <div class="c-footer-txt" style="text-align:right">
            <div>BORN: ${ts}</div>
            <div>VOIDCHI UNIVERSE™</div>
          </div>
        </div>
      </div>
    </div>
  `;

  el.addEventListener('click', (e) => {
    if (e.target.classList.contains('btn-challenge')) return;
    toggleSelect(v.id);
  });

  return el;
}

// ===================== RENDER =====================
function renderCards(agents) {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = '';
  orbStoppers.forEach(s=>s());
  orbStoppers = [];

  if (!agents.length) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;font-family:Share Tech Mono,monospace;font-size:12px;color:var(--dim);letter-spacing:2px;">NO AGENTS FOUND</div>';
    return;
  }

  agents.forEach((v, i) => {
    const card = buildCard(v, i * 50);
    grid.appendChild(card);
    setTimeout(() => {
      const canvas = card.querySelector('canvas.orb');
      if (canvas) orbStoppers.push(drawOrb(canvas, canvas.dataset.tier, parseFloat(canvas.dataset.phi)));
      const fill = card.querySelector('.echo-fill');
      if (fill) fill.style.width = fill.dataset.target + '%';
      // restore gap data if exists
      if (lastGapData[v.id]) showGapVisualization(v.id, lastGapData[v.id]);
    }, i * 50 + 80);
  });

  updateBreedBtn();
}

// ===================== SELECT =====================
function toggleSelect(id) {
  const idx = selected.indexOf(id);
  if (idx > -1) selected.splice(idx, 1);
  else {
    if (selected.length < 2) selected.push(id);
    else selected = [id];
  }
  selectedSingle = selected.length === 1 ? selected[0] : null;
  if (selectedSingle) localStorage.setItem('lastSelectedVoidchi', selectedSingle);
  else localStorage.removeItem('lastSelectedVoidchi');

  // update visual selection
  document.querySelectorAll('.voidchi-card').forEach(el => {
    const isNowSelected = selected.includes(el.dataset.id);
    el.classList.toggle('selected', isNowSelected);
  });

  updateBreedBtn();
  setNotesSelectedLabel();
  if (selectedSingle) reloadNotes();
  else renderNotes([]);
}

function updateBreedBtn() {
  const btn = document.getElementById('breedBtn');
  btn.disabled = selected.length !== 2;
  btn.textContent = `⬡ BREED SELECTED (${selected.length}/2)`;
}

// ===================== FILTER / SORT =====================
function filterCards(tier, btn) {
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  filteredVoidchis = tier === 'all' ? allVoidchis : allVoidchis.filter(v=>getTier(v)===tier);
  renderCards(filteredVoidchis);
}

function sortCards(by, btn) {
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const sorted = [...allVoidchis].sort((a,b) => parseFloat(b.consciousness_level||0) - parseFloat(a.consciousness_level||0));
  renderCards(sorted);
}

// ===================== LIVE UPDATE (without full re-render) =====================
function updateCardLive(id, data) {
  const card = document.getElementById(`card-${id}`);
  if (!card) return;
  const phi = parseFloat(data.new_phi ?? data.phi ?? data.consciousness_level ?? 0);
  if (phi > 0) {
    const phiEl = card.querySelector('.phi-val');
    if (phiEl) phiEl.textContent = `Φ ${phi.toFixed(2)}`;
  }
  card.classList.add('updating');
  setTimeout(()=>card.classList.remove('updating'), 900);
}

// ===================== CHALLENGE =====================
async function challenge(id) {
  const card = document.getElementById(`card-${id}`);
  card.classList.add('updating');
  try {
    const res = await fetch(`${API}/voidchi/${id}/challenge`, {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'omit'
    });
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
    const result = JSON.parse(text);
    lastGapData[id] = result;
    updateCardLive(id, result);
    showGapVisualization(id, result);
    pushRecentError(result.gap_magnitude ?? result.gap);
    updateSystemView();
    setTimeout(()=>card.classList.remove('updating'), 900);
  } catch(e) {
    console.error('Learning event failed:', e);
    alert('Learning event failed: ' + e.message);
    card.classList.remove('updating');
  }
}

function showGapVisualization(id, result) {
  const container = document.getElementById(`gap-container-${id}`);
  if (!container) return;

  const le = result?.learning_event || null;
  const gap = parseFloat(result.gap_magnitude ?? result.gap ?? 0);
  const wasAccurate = !!result.was_accurate;
  const statusColor = wasAccurate ? 'var(--green)' : 'var(--red)';
  const statusText = wasAccurate ? 'ACCURATE' : 'LEARNING';

  const phiDelta = typeof result.phi_delta === 'number' ? result.phi_delta : 0;
  const sign = phiDelta >= 0 ? '+' : '';

  let content = '';
  if (le) {
    const acc = typeof le.prediction_accuracy === 'number' ? le.prediction_accuracy : (1-gap)*100;
    const stateEv = typeof le.state_evolution === 'number' ? le.state_evolution : phiDelta;
    const total = typeof le.total_events === 'number' ? le.total_events : result.challenge_count;
    content = `
      <div>ACCURACY: ${acc.toFixed(1)}% &nbsp;|&nbsp; STATE Δ: ${sign}${Number(stateEv).toFixed(4)}</div>
      ${total != null ? `<div>TOTAL EVENTS: ${total}</div>` : ''}
      <div>PREDICTION ERROR: ${gap.toFixed(4)}</div>
    `;
  } else {
    content = `
      <div>${escapeHtml(result.msg || '')}</div>
      <div>PREDICTION ERROR: ${gap.toFixed(4)}</div>
      <div>STATE Δ: ${sign}${phiDelta.toFixed(4)}</div>
      ${result.challenge_count != null ? `<div>EVENTS: ${result.challenge_count}</div>` : ''}
    `;
  }

  container.innerHTML = `
    <div class="learning-section">
      <div class="learning-header">
        <span class="learning-label">LEARNING EVENT</span>
        <span class="learning-status" style="background:${statusColor};color:#000;">${statusText}</span>
      </div>
      ${content}
    </div>
  `;
}

// ===================== SYSTEM VIEW =====================
function pushRecentError(err) {
  const n = Number(err);
  if (!Number.isFinite(n)) return;
  recentErrors.push(n);
  while (recentErrors.length > 50) recentErrors.shift();
}

function mean(arr) {
  if (!arr?.length) return null;
  return arr.reduce((s,v)=>s+v,0)/arr.length;
}

function updateSystemView() {
  const now = new Date();
  const voidchis = allVoidchis;

  document.getElementById('rtAgentsAlive').textContent = voidchis.length;

  if (systemStartTime) {
    const ms = now - systemStartTime;
    const d = Math.floor(ms/86400000), h = Math.floor((ms%86400000)/3600000);
    document.getElementById('rtUptime').textContent = `${d}d ${h}h`;
  }

  const m = mean(recentErrors);
  document.getElementById('rtAvgError').textContent = m != null ? m.toFixed(4) : '—';

  if (lastGlobalStats) {
    const lr = lastGlobalStats.learning_rate ?? lastGlobalStats.events_per_minute;
    document.getElementById('rtLearningRate').textContent = lr != null ? Number(lr).toFixed(2) : '—';
  }

  const fifteenMin = 15*60*1000;
  const freshCount = voidchis.filter(v => {
    const t = v.updated_at || v.last_interaction;
    return t && (now - new Date(t)) < fifteenMin;
  }).length;
  document.getElementById('rtFreshPct').textContent = voidchis.length > 0 ? Math.round(freshCount/voidchis.length*100) : 0;

  const sixHours = 6*3600000;
  const stale = voidchis.filter(v => {
    const t = v.updated_at || v.last_interaction;
    return !t || (now - new Date(t)) > sixHours;
  }).length;
  document.getElementById('rtStaleCount').textContent = stale;
}

// ===================== NOTES / CHAT =====================
function setNotesSelectedLabel() {
  const lbl = document.getElementById('notesSelectedLabel');
  const btn = document.getElementById('sendNoteBtn');
  if (!selectedSingle) {
    lbl.textContent = '(select an agent to communicate)';
    btn.disabled = true;
    return;
  }
  const v = allVoidchis.find(x=>x.id===selectedSingle);
  lbl.textContent = v ? `→ ${v.name}` : '';
  btn.disabled = false;
}

async function loadBootInfo() {
  try {
    const res = await fetch(`${API}/health`, {credentials:'omit'});
    if (!res.ok) return;
    const data = await res.json();
    document.getElementById('bootIdLabel').textContent = data.server_boot_id || '-';
  } catch(e) {}
}

async function reloadNotes() {
  if (!selectedSingle) return;
  await loadBootInfo();
  try {
    const res = await fetch(`${API}/voidchi/${selectedSingle}/notes?limit=50`, {credentials:'omit'});
    const text = await res.text();
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = JSON.parse(text);
    notesCache[selectedSingle] = data.notes || [];
    renderNotes(notesCache[selectedSingle]);
    if (data.server_boot_id) document.getElementById('bootIdLabel').textContent = data.server_boot_id;
  } catch(e) {
    renderNotes([{author:'system',content:`History unavailable: ${e.message}`,created_at:new Date().toISOString()}]);
  }
}

async function sendNote() {
  if (!selectedSingle) return;
  const input = document.getElementById('noteInput');
  const content = (input.value||'').trim();
  if (!content) return;
  input.value = ''; input.disabled = true;
  const btn = document.getElementById('sendNoteBtn');
  btn.disabled = true; btn.textContent = 'THINKING...';
  try {
    const res = await fetch(`${API}/voidchi/${selectedSingle}/chat`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      credentials:'omit', body:JSON.stringify({message:content})
    });
    const text = await res.text();
    if (!res.ok) throw new Error(JSON.parse(text)?.error || `HTTP ${res.status}`);
    const data = JSON.parse(text);
    const existing = notesCache[selectedSingle] || [];
    if (data.user_message) notesCache[selectedSingle] = [data.user_message,...existing];
    if (data.ai_response) notesCache[selectedSingle] = [data.ai_response,...(notesCache[selectedSingle]||[])];
    notesCache[selectedSingle] = (notesCache[selectedSingle]||[]).slice(0,50);
    renderNotes(notesCache[selectedSingle]);
    if (data.server_boot_id) document.getElementById('bootIdLabel').textContent = data.server_boot_id;
  } catch(e) {
    const err = {author:'system',content:`⚠️ Chat failed: ${e.message}`,created_at:new Date().toISOString()};
    notesCache[selectedSingle] = [err,...(notesCache[selectedSingle]||[])].slice(0,50);
    renderNotes(notesCache[selectedSingle]);
  } finally {
    input.disabled = false; btn.disabled = false; btn.textContent = 'SEND'; input.focus();
  }
}

function renderNotes(notes) {
  const panel = document.getElementById('notesPanel');
  if (!selectedSingle) {
    panel.innerHTML = '<div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--dim);padding:8px;">Select an agent to view communication history.</div>';
    return;
  }
  if (!notes?.length) {
    panel.innerHTML = '<div style="font-family:Share Tech Mono,monospace;font-size:10px;color:var(--dim);padding:8px;">No messages yet. Send the first one.</div>';
    return;
  }
  panel.innerHTML = notes.map(n => {
    const isUser = n.author==='user';
    const isSystem = n.author==='system';
    const borderColor = isUser ? 'var(--blue)' : isSystem ? 'var(--orange)' : 'var(--purple)';
    const bgColor = isUser ? 'rgba(37,99,235,0.06)' : isSystem ? 'rgba(245,158,11,0.06)' : 'rgba(124,58,237,0.06)';
    return `
      <div class="note-card" style="border-left-color:${borderColor};background:${bgColor}">
        <div class="note-head">
          <strong style="color:${borderColor}">${escapeHtml(n.author||'unknown')}</strong>
          <span>${escapeHtml(n.created_at||'')}</span>
        </div>
        <div class="note-content">${escapeHtml(n.content||'')}</div>
      </div>
    `;
  }).join('');
  panel.scrollTop = panel.scrollHeight;
}

// ===================== LOAD =====================
async function loadVoidchis() {
  try {
    const res = await fetch(`${API}/voidchis`, {credentials:'omit'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    allVoidchis = await res.json();
    allVoidchis = allVoidchis.map(v => {
      v.personality_traits = v.personality_traits && typeof v.personality_traits === 'object' ? v.personality_traits : {};
      v.regulatory_traits  = v.regulatory_traits  && typeof v.regulatory_traits  === 'object' ? v.regulatory_traits  : {};
      return v;
    });

    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('navStatus').textContent = `${allVoidchis.length} AGENTS ONLINE`;
    setConnected(true);

    // restore selection
    const last = localStorage.getItem('lastSelectedVoidchi');
    if (last && allVoidchis.some(v=>v.id===last)) { selected=[last]; selectedSingle=last; }

    filteredVoidchis = allVoidchis;
    renderCards(allVoidchis);
    updateSystemView();
    loadStats();
    setNotesSelectedLabel();
    if (selectedSingle) reloadNotes();
  } catch(e) {
    console.error('Load error:', e);
    document.getElementById('loadingState').innerHTML = `
      <div style="font-family:Share Tech Mono,monospace;font-size:12px;color:var(--red);letter-spacing:2px;text-align:center;padding:40px;">
        ⚠ CONNECTION FAILED<br><span style="color:var(--dim);font-size:10px;margin-top:8px;display:block">${e.message}</span>
      </div>
    `;
  }
}

async function loadStats() {
  try {
    const res = await fetch(`${API}/stats/global`, {credentials:'omit'});
    if (!res.ok) return;
    const stats = await res.json();
    lastGlobalStats = stats;
    document.getElementById('total').textContent = stats.total_voidchis || 0;
    document.getElementById('gapsProcessed').textContent = stats.total_learning_events || 0;
    document.getElementById('autonomous').textContent = stats.autonomous_count || 0;
    if (typeof stats.avg_consciousness === 'number') {
      document.getElementById('consciousness').textContent = stats.avg_consciousness.toFixed(2);
    }
    if (stats.oldest_voidchi_created_at && !systemStartTime) {
      systemStartTime = new Date(stats.oldest_voidchi_created_at);
      updateRuntimeDisplay();
    }
  } catch(e) { console.error('Stats error:', e); }
}

function updateRuntimeDisplay() {
  if (!systemStartTime) return;
  const ms = new Date() - systemStartTime;
  const d = Math.floor(ms/86400000), h = Math.floor((ms%86400000)/3600000);
  document.getElementById('runtimeLabel').textContent = `${d}d ${h}h (since ${systemStartTime.toLocaleDateString()})`;
  updateSystemView();
}

// ===================== MODALS =====================
function openCreate() { document.getElementById('createModal').classList.add('active'); document.getElementById('createName').value=''; document.getElementById('createName').focus(); }
function closeCreate() { document.getElementById('createModal').classList.remove('active'); }
function openBreed() { document.getElementById('breedModal').classList.add('active'); document.getElementById('breedName').value=''; document.getElementById('breedName').focus(); }
function closeBreed() { document.getElementById('breedModal').classList.remove('active'); }

async function create() {
  const name = document.getElementById('createName').value.trim();
  if (!name) return alert('Enter an agent name');
  try {
    const res = await fetch(`${API}/voidchi/create`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      credentials:'omit', body:JSON.stringify({name})
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    closeCreate();
    await loadVoidchis();
  } catch(e) { alert('Creation failed: ' + e.message); }
}

async function breed() {
  const name = document.getElementById('breedName').value.trim();
  if (!name) return alert('Enter a name');
  if (selected.length !== 2) return alert('Select 2 agents');
  try {
    const res = await fetch(`${API}/voidchi/breed`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      credentials:'omit',
      body:JSON.stringify({parent1_id:selected[0],parent2_id:selected[1],offspring_name:name})
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    selected=[]; selectedSingle=null;
    localStorage.removeItem('lastSelectedVoidchi');
    closeBreed(); updateBreedBtn(); setNotesSelectedLabel(); renderNotes([]);
    await loadVoidchis();
  } catch(e) { alert('Breeding failed: ' + e.message); }
}

// ===================== UTILS =====================
function escapeHtml(str) {
  return (str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

// ===================== STARTUP =====================
loadVoidchis();
loadBootInfo();
setInterval(updateRuntimeDisplay, 3600000);
setInterval(updateSystemView, 30000);
setInterval(loadStats, 60000);

document.addEventListener('keydown', e => {
  if (e.key==='Escape'){closeCreate();closeBreed();}
  if (e.key==='Enter' && document.activeElement===document.getElementById('noteInput')) sendNote();
});
</script>
</body>
</html>

