<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BAP SecOps — Live Ops + Compliance</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body{background:#0b1220;color:#e6f0fb;font-family:ui-sans-serif,system-ui}
  .glass{background:rgba(255,255,255,0.06);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.08)}
  .btn{padding:.45rem .7rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.15)}
</style>
</head>
<body class="p-3">
  <div class="grid md:grid-cols-3 gap-3">
    <!-- Risk + KPIs -->
    <div class="glass rounded-lg p-3">
      <div class="flex items-center justify-between"><h2 class="font-bold">Live Risk</h2><button id="simulate" class="btn">Simulate</button></div>
      <canvas id="riskChart" class="mt-3"></canvas>
      <div class="grid grid-cols-3 gap-3 mt-3 text-center">
        <div><div class="text-xs opacity-70">MTTD</div><div id="mttd" class="text-2xl font-extrabold">28m</div></div>
        <div><div class="text-xs opacity-70">MTTR</div><div id="mttr" class="text-2xl font-extrabold">9h</div></div>
        <div><div class="text-xs opacity-70">Open Incidents</div><div id="openInc" class="text-2xl font-extrabold">7</div></div>
      </div>
    </div>

    <!-- Incident Feed -->
    <div class="glass rounded-lg p-3">
      <h2 class="font-bold mb-2">Incident Feed</h2>
      <ul id="feed" class="space-y-2 text-sm"></ul>
    </div>

    <!-- Compliance -->
    <div class="glass rounded-lg p-3">
      <div class="flex items-center justify-between"><h2 class="font-bold">Compliance</h2>
        <button id="export" class="btn">Export CSV</button></div>
      <div class="mt-3 text-sm">
        <div class="mb-2">SOC2 Coverage <span id="soc2Pct" class="float-right">72%</span>
          <div class="h-2 bg-white bg-opacity-10 rounded"><div id="soc2Bar" class="h-2 bg-green-400 rounded" style="width:72%"></div></div>
        </div>
        <div class="mb-2">ISO 27001 <span id="isoPct" class="float-right">61%</span>
          <div class="h-2 bg-white bg-opacity-10 rounded"><div id="isoBar" class="h-2 bg-blue-400 rounded" style="width:61%"></div></div>
        </div>
        <div class="mb-2">NIST CSF <span id="nistPct" class="float-right">54%</span>
          <div class="h-2 bg-white bg-opacity-10 rounded"><div id="nistBar" class="h-2 bg-purple-400 rounded" style="width:54%"></div></div>
        </div>
      </div>
      <div class="mt-3 text-xs opacity-70">Read‑only to Splunk • CrowdStrike • Okta. SSO • RBAC • Audit logs.</div>
    </div>
  </div>

<script>
// Risk doughnut
const ctx = document.getElementById('riskChart').getContext('2d');
let risk = 72;
const riskChart = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Risk','Remaining'],
    datasets: [{
      data: [risk, 100-risk],
      borderWidth: 0
    }]
  },
  options: {
    responsive:true,
    cutout: '70%',
    plugins: {legend:{display:false},
      tooltip:{enabled:false}
    }
  }
});
// Center text plugin
Chart.defaults.font.family = "ui-sans-serif, system-ui";
const centerLabel = {id:'centerLabel', afterDraw(chart, args, pluginOptions){
  const {ctx, chartArea:{width, height}} = chart;
  ctx.save(); ctx.fillStyle='#e6f0fb'; ctx.font='700 22px ui-sans-serif';
  ctx.textAlign='center'; ctx.fillText('RISK', chart.getDatasetMeta(0).data[0].x, chart.getDatasetMeta(0).data[0].y-4);
  ctx.font='700 28px ui-sans-serif'; ctx.fillText(risk+'%', chart.getDatasetMeta(0).data[0].x, chart.getDatasetMeta(0).data[0].y+24);
}};
riskChart.config.plugins = [centerLabel]; riskChart.update();

// Feed
const feed = document.getElementById('feed');
const seeds = [
  "Multiple failed logins — Owner: IAM",
  "EDR alert: suspicious PowerShell — Owner: SecOps",
  "MFA disabled on 3 accounts — Owner: IT",
  "Unpatched critical CVE on 12 hosts — Owner: Platform",
  "Privileged role granted outside CAB — Owner: Change Mgmt",
  "Public S3 bucket detected — Owner: Cloud",
  "High-risk vendor missing questionnaire — Owner: GRC"
];
function renderFeed(items){
  feed.innerHTML = "";
  items.forEach(t => {
    const li = document.createElement('li');
    li.className = "p-2 rounded bg-white bg-opacity-5";
    li.textContent = t;
    feed.appendChild(li);
  });
}
renderFeed(seeds);

// Compliance values
function setPct(idTxt,idBar,val){
  document.getElementById(idTxt).textContent = val + "%";
  document.getElementById(idBar).style.width = val + "%";
}
let soc2=72, iso=61, nist=54;

// Simulate
document.getElementById('simulate').onclick = ()=>{
  // vary risk & metrics
  risk = Math.max(20, Math.min(95, risk + (Math.random()*16-8)));
  riskChart.data.datasets[0].data = [risk, 100-risk]; riskChart.update();
  document.getElementById('mttd').textContent = Math.round(18 + Math.random()*20) + "m";
  document.getElementById('mttr').textContent = Math.round(4 + Math.random()*16) + "h";
  document.getElementById('openInc').textContent = Math.round(4 + Math.random()*9);
  // compliance drifts
  soc2 = Math.max(40, Math.min(95, soc2 + (Math.random()*6-3)));
  iso  = Math.max(35, Math.min(90, iso  + (Math.random()*6-3)));
  nist = Math.max(30, Math.min(85, nist + (Math.random()*6-3)));
  setPct('soc2Pct','soc2Bar',Math.round(soc2));
  setPct('isoPct','isoBar',Math.round(iso));
  setPct('nistPct','nistBar',Math.round(nist));
  // shuffle feed top 5
  renderFeed(seeds.sort(()=>0.5-Math.random()).slice(0,5));
};

// Export CSV
document.getElementById('export').onclick = ()=>{
  const rows = [
    ["Framework","Control","Status","Owner","Evidence"],
    ["SOC2","CC6.1 — Access Control", soc2>70?"Covered":"Gap","Security","Okta group membership + review"],
    ["ISO27001","A.5 — Policies", iso>60?"Covered":"Gap","GRC","Policy doc + sign-off"],
    ["NIST CSF","PR.AC-1 — Id Mgmt", nist>60?"Covered":"Gap","IAM","MFA logs + identity proof"]
  ];
  const csv = rows.map(r => r.map(x => `"${String(x).replace('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = "BAP_Compliance_Export.csv";
  a.click();
};
</script>
</body>
</html>
